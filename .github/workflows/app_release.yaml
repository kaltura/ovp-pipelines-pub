## CI - App Release
name: App Release
run-name: App Release

on:
  workflow_call:
    inputs:
      build-steps:
        description: Build steps
        required: false
        type: string
      upload-asset:
        description: Upload asset
        required: false
        type: boolean
        default: false
      env:
        description: Environment
        #required: true
        type: string
        default: dev
      lint-steps:
        description: Lint steps
        required: false
        type: string
      test-steps:
        description: Test steps
        required: false
        type: string

jobs:
  accept-prod:
    if: ${{ inputs.env == 'prod' }}
    runs-on: ubuntu-latest
    name: Accept Prod
    environment: Prod
    steps:
      - name: accept workflow on prod
        run: |
          echo "accepted"
  lint-npm:
    name: Lint NPM
    if: (always()) && inputs.lint-steps && (needs.accept-prod.result == 'success' || needs.accept-prod.result == 'skipped')
    needs: accept-prod
    uses: ./.github/workflows/run_npm.yaml
    with:
      build-steps: ${{ inputs.lint-steps }}
  test-npm:
    name: Test NPM
    if: (always()) && inputs.test-steps && (needs.accept-prod.result == 'success' || needs.accept-prod.result == 'skipped')
    needs: accept-prod
    uses: ./.github/workflows/run_npm.yaml
    with:
      build-steps: ${{ inputs.test-steps }}
  build-npm:
    name: Build NPM
    if: (always()) && (needs.accept-prod.result == 'success' || needs.accept-prod.result == 'skipped')
    needs: accept-prod
    uses: ./.github/workflows/run_npm.yaml
    with:
      build-steps: ${{ inputs.build-steps }}
      upload-artifact: ${{ inputs.upload-asset }}
  upload-asset:
    name: Upload Asset
    if: (always()) && inputs.upload-asset && (needs.build-npm.result == 'success')
    needs: build-npm
    uses: ./.github/workflows/upload_release_asset.yaml
    with:
      asset-name: ${{ needs.build-npm.outputs.artifact }}